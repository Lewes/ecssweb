{% extends 'portal/base.html' %}

{% load static %}
{% load website_extra %}
{% load shop_extra %}

{% block title %}Shop - ECSS{% endblock %}

{% block pagestyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'shop/styles/shop.css' %}">
{% endblock %}

{% block portalcontent %}
<section>
  <h1>Shop</h1>
  <form target="paypal" action="https://www.paypal.com/cgi-bin/webscr" method="post" >
    <input type="hidden" name="cmd" value="_s-xclick">
    <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----MIIG1QYJKoZIhvcNAQcEoIIGxjCCBsICAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYBe8A8rxz5gm4skhYWenPOOEgwSJKfJpcT9V9VEidBiENzm4GQsywB/m69OkOZuuTUxkWIv2gSIlqeYJa9pj+JcWbRUppUPFiqUEYdrlJ2+SnL5XYSCIwVpYdtSXfWYX1uR5EL0hvqMsIIp2Bil9SJI7ecGyAIJfRUjBudW2zLVNTELMAkGBSsOAwIaBQAwUwYJKoZIhvcNAQcBMBQGCCqGSIb3DQMHBAjaTN7r7vbJxIAwR5MuGK0g342qweXU9G41P3D40GXQJHmj59OOHuwe5yAVRtpI95eQT9k4YR76njAXoIIDhzCCA4MwggLsoAMCAQICAQAwDQYJKoZIhvcNAQEFBQAwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tMB4XDTA0MDIxMzEwMTMxNVoXDTM1MDIxMzEwMTMxNVowgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDBR07d/ETMS1ycjtkpkvjXZe9k+6CieLuLsPumsJ7QC1odNz3sJiCbs2wC0nLE0uLGaEtXynIgRqIddYCHx88pb5HTXv4SZeuv0Rqq4+axW9PLAAATU8w04qqjaSXgbGLP3NmohqM6bV9kZZwZLR/klDaQGo1u9uDb9lr4Yn+rBQIDAQABo4HuMIHrMB0GA1UdDgQWBBSWn3y7xm8XvVk/UtcKG+wQ1mSUazCBuwYDVR0jBIGzMIGwgBSWn3y7xm8XvVk/UtcKG+wQ1mSUa6GBlKSBkTCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb22CAQAwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQUFAAOBgQCBXzpWmoBa5e9fo6ujionW1hUhPkOBakTr3YCDjbYfvJEiv/2P+IobhOGJr85+XHhN0v4gUkEDI8r2/rNk1m0GA8HKddvTjyGw/XqXa+LSTlDYkqI8OwR8GEYj4efEtcRpRYBxV8KxAW93YDWzFGvruKnnLbDAF6VR5w/cCMn5hzGCAZowggGWAgEBMIGUMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbQIBADAJBgUrDgMCGgUAoF0wGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMjAwMTMwMTQyMTUzWjAjBgkqhkiG9w0BCQQxFgQUuYgwBNNRfVbzb9kV0MP1eZW4YKwwDQYJKoZIhvcNAQEBBQAEgYBUE4en8wrj2zCDmIVcJT51MB8vxYT3ATeP8BATbjggv8pT0AMdFBurzNQTtt6hjkfvE1rfiU0mpV2BL6K0CC59gj5Rxi6nTIC6q4orQrAAL/1TtBoe5btxv6oeDV91SW0wv14ix/jz+yrt+YGSqFZy/kqLekEqxny37vyXMbGgcw==-----END PKCS7-----">
    <input type="image" src="https://www.paypalobjects.com/en_GB/i/btn/btn_viewcart_LG.gif" border="0" name="submit" alt="View Cart">
  </form>
  <div class="card">
    <h5 class="card-header">
      {{ item.name }}
    </h5>
    <div class="card-body row">
      <div class="col-md-5 mb-3">
        {% if item.itemimage_set.all|length <= 1 %}
        {% with first_itemimage=item.itemimage_set.all|first %}
        <img class="img-fluid" src="{{ first_itemimage.image.url }}" alt="{{ item.name }}">
        {% endwith %}
        {% else %}
        <div id="itemCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
          <ol class="carousel-indicators">
            {% for itemimage in item.itemimage_set.all %}
            <li data-target="#itemCarousel" data-slide-to="{{ forloop.counter0 }}" class="{% if forloop.counter == 1 %}active{% endif %}"></li>
            {% endfor %}
          </ol>
          <div class="carousel-inner">
            {% for itemimage in item.itemimage_set.all %}
            <div class="carousel-item shop-carousel-item {% if forloop.counter == 1 %}active{% endif %}">
              <img class="d-block img-fluid mx-auto" src="{{ itemimage.image.url }}" alt="{{ item.name }}">
            </div>
            {% endfor %}
          </div>
          <a class="carousel-control-prev" href="#itemCarousel" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
          </a>
          <a class="carousel-control-next" href="#itemCarousel" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
          </a>
        </div>
        <div class="flex-row item-thumbnails d-none d-md-flex">
          {% for itemimage in item.itemimage_set.all %}
          <div class="d-flex item-thumbnail img-thumbnail" data-target="#itemCarousel" data-slide-to="{{ forloop.counter0 }}">
            <img class="d-block img-fluid mx-auto" src="{{ itemimage.image.url }}" alt="{{ item.name }}">
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="col-md-7">
        {% if item.sale.is_future %}
        <div class="alert alert-warning">
          Sale for this item is not yet open. The sale opens between {{ item.sale.start|date }} {{ item.sale.start|time:"H:i" }} and {{ item.sale.end|date }} {{ item.sale.end|time:"H:i" }}.
        </div>
        {% endif %}
        {% if item.itempermission_set.all and not user|has_any_perms_item:item %}
        <div class="alert alert-warning">
          This item is not for the current user.
        </div>
        {% endif %}
        <div class="alert alert-danger" id="jsWarning">
          <b>Error</b>: JavaScript is not enabled. JavaScript is required to send the correct order information.
        </div>
        <h5>
          {{ item.name }}
        </h5>
        <div>{{ item.description|md|safe }}</div>
        <form action="https://www.paypal.com/cgi-bin/webscr" method="post" id="orderForm">        
          <input type="hidden" name="cmd" value="_s-xclick">
          <input type="hidden" name="hosted_button_id" value="{{ item.paypal_button_id }}">

          <input type="hidden" name="item_name" value="{{ item.name }}">
          <input type="hidden" name="amount" value="1">

          <input type="hidden" name="on0" value="options">
          <input type="hidden" name="os0" value="">

          {% for item_option in item.itemoption_set.all|dictsort:"paypal_option_number" %}
          <div class="form-group">
            <label for="input{{ item_option.paypal_option_number }}">{{ item_option.name }}</label>
            <input type="hidden" name="on{{ item_option.paypal_option_number }}" value="{{ item_option.paypal_option_name }}">
            {% if item_option.auto_value == 'username' %}
            <input class="form-control" name="os{{ item_option.paypal_option_number }}" value="{{ user.username }}" id="input{{ item_option.paypal_option_number }}" readonly>
            {% else %}
            <select class="form-control" name="os{{ item_option.paypal_option_number }}" id="input{{ item_option.paypal_option_number }}" required>
              <option value="" selected disabled>Select {{ item_option.name }}</option>
              {% for option_choice in item_option.optionchoice_set.all|msort:"sort_order" %}
              <option value="{{ option_choice.value }}">{{ option_choice.name }}</option>
              {% endfor %}
            </select>
          {% endif %}
          </div>
          {% endfor %}

          <div class="mb-3">Â£{{ item.price }}</div>

          <input type="image" name="submit" src="https://www.paypalobjects.com/en_US/i/btn/btn_buynow_LG.gif" alt="Buy Now" id="paypalButton" hidden>

          <div class="alert alert-warning">
            Refund may not be possible due to the items are customarily ordered. If purchasing items, you will be contacted upon item delivery, during semester 2. You will receive time slots to collect your purchased items, and if these cannot be met please contact the committee via email. Failure to contact committee and failure to collect will result in no guarantee you will get the items, with no refund available.
          </div>

          <div class="text-muted">
            <small>
              The order and payment is handled by PayPal. By clicking the "Buy Now" button, you order information will be sent to PayPal (this may also include your university username), and we may contact you regarding your order.
            </small>
          </div>
        </form>
        <div class="mt-3">
          <b>Sale for this item ends on {{ item.sale.end|date }} at {{ item.sale.end|time:"H:i" }}.</b>
        </div>
        <div class="text-muted mt-3">
          <small>
            If having difficulities purchasing on the website, please contact the committee.
          </small>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block pagescript %}
{{ block.super }}
<script>
// show "Buy Now" button and hide js warning
$('#paypalButton').removeAttr('hidden');
$('#jsWarning').prop('hidden', true);

var optionsFields = new Array();
{% for item_option in item.itemoption_set.all %}
optionsFields.push('on{{ item_option.paypal_option_number }}');
optionsFields.push('os{{ item_option.paypal_option_number }}');
{% endfor %}

$('#paypalButton').click(function() {
  $("#orderForm>input[name='os0']").val($("#orderForm :input").filter(function() {
    return optionsFields.includes(this.name);
  }).serialize());
});
</script>
{% endblock %}
