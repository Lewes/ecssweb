{% extends 'portal/base.html' %}

{% load static %}
{% load website_extra %}
{% load shop_extra %}

{% block title %}Shop - ECSS{% endblock %}

{% block pagestyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'shop/styles/shop.css' %}">
{% endblock %}

{% block portalcontent %}
<section>
  <h1>Shop</h1>
  {% if sales %}
  <form target="paypal" action="https://www.paypal.com/cgi-bin/webscr" method="post" >
    <input type="hidden" name="cmd" value="_s-xclick">
    <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----">
    <input type="image" src="https://www.paypalobjects.com/en_GB/i/btn/btn_viewcart_LG.gif" border="0" name="submit" alt="View Cart">
  </form>
  {% for sale in sales %}
  <div class="card my-3">
    <h5 class="card-header">
      {{ sale.name }}
    </h5>
    <div class="card-body pt-2">
      {% if sale.is_future %}
      <div class="alert alert-warning">
        This sale is not yet open. This sale opens between {{ sale.start|date }} {{ sale.start|time:"H:i" }} and {{ sale.end|date }} {{ sale.end|time:"H:i" }}.
      </div>
      {% endif %}
      {% if sale.item_set.all %}
      <div class="d-inline-flex flex-wrap">
        {% for item in sale.item_set.all|msort:"sort_order" %}
        {% if user|has_group:"committee" or not item.itempermission_set.all or user|has_any_perms_item:item %}
        <div class="card shop-item-card">
          {% if item.itemimage_set.all %}
          {% with default_itemimage=item.itemimage_set.all|msort:"sort_order"|first %}
          <img class="card-img-top" src="{{ default_itemimage.image.url }}" alt="{{ item.name }}">
          {% endwith %}
          {% else %}
          <!-- src leave black if no image -->
          <img class="card-img-top" src="" alt="{{ item.name }}">
          {% endif %}
          <a href="{% url 'shop:item' sale=sale.codename item=item.codename %}">
            <h5 class="card-header">
              {{ item.name }}
            </h5>
          </a>
          <div class="card-body">
            <div>
              {{ item.description|md|striptags|truncatewords:20 }}
            </div>
            <div class="badge badge-info">Â£{{ item.price }}</div>
            {% if item.itempermission_set.all and not user|has_any_perms_item:item %}
            <div class="alert alert-warning mb-0 mt-3">
              This item is not for the current user.
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
      {% else %}
      <p class="card-text">Nothing is on sale in this sale.</p>
      {% endif %}
      <div>
        {% if not user|has_group:"committee" %}
        <p>
          <small>There are {{ sale.item_set.count }} items in this sale, and any items not for the current user are hidden.</small>
        </p>
        {% endif %}
        <p class="mb-0">
          <b>This sale ends on {{ sale.end|date }} at {{ sale.end|time:"H:i" }}.</b>
        </p>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <p>Nothing is currently on sale here.</p>
  {% endif %}
</section>
{% endblock %}
